---
title: "Spotify Data Analysis"
author: 
- "Mencius Qin, Rachel Hyeon"
- 'Style Guide: tidyverse style guide'
output:
  pdf_document:
    toc: yes
  html_document:
    code_folding: show
    toc: yes
    toc_float: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loading, include=FALSE}
# Import libraries
library(tidyverse)
library(factoextra)
library(ggridges)
library(GGally)

# Load data
spotify <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-01-21/spotify_songs.csv') %>% na.omit()
```

# Abstract:



# Introduction:



# Data:


```{r genre-popularity}
# Graph code
genre_ridgeline <- spotify %>%
  ggplot(aes(x = track_popularity, 
             y = playlist_genre,
             height = stat(density),
             fill = playlist_genre)) +
  geom_density_ridges(stat = "density") +
  theme_bw() +
  labs(x = "Popularity of the Song", y = "Genre",
       title = "Ridgeline plot of Song Popularity of different Genre
               (All Genre contains a mode of low popularity)")

plot(genre_ridgeline)
```



```{r pop-heat}
pop_heat <- spotify %>% 
  ggplot(aes(x = loudness, y = instrumentalness)) +
  stat_density2d(geom = "tile", contour = FALSE) +
  geom_point(aes(color = track_popularity), alpha = .2) + 
  scale_color_gradient(low = "lightblue", high = "orange") +
  theme_bw() + 
  labs(title = "Heat Map")

plot(pop_heat)
```




# Methods:



# Results:

## Question 1: What is the effect of quantitative variables explaining song characteristics on track popularity?

```{r pca-analysis, include=FALSE}
spotify_quant <- spotify[, c(4, 12:13, 15, 17:23)]

spotify_pca <- prcomp(dplyr::select(spotify_quant, danceability:duration_ms),
                     center = TRUE, scale. = TRUE)
summary(spotify_pca)
```

```{r scree-plot, include=FALSE}
fviz_eig(spotify_pca, addlabels = TRUE, ncp = 10) +
  geom_hline(yintercept = 100 * (1 / ncol(spotify_pca$x)), 
             linetype = "dashed", color = "red")
```

```{r pop-pca, include=FALSE}
spotify_pc_matrix <- spotify_pca$x

pop_pca_df <- spotify %>% 
  mutate(pc1 = spotify_pc_matrix[,1], pc2 = spotify_pc_matrix[,2],
         pc3 = spotify_pc_matrix[,3], pc4 = spotify_pc_matrix[,4])
pop_pca <- pop_pca_df %>%
  ggplot(aes(x = pc1, y = pc2)) +
  geom_point(aes(color = track_popularity), alpha = 0.5) +
  scale_colour_gradient(low = "white", high = "orange") +
  theme_bw() +
  labs(x = "PC 1", y = "PC 2", color = "Track Popularity")

plot(pop_pca)
```

```{r pop-biplot, include=FALSE}
fviz_pca_biplot(spotify_pca,
                # Plot PC1 and PC3
                axes = c(1, 2), label = "var",
                # Change the alpha for the observations - 
                # which is represented by ind
                alpha.ind = .25,
                # Modify the alpha for the variables (var):
                alpha.var = .5,
                repel = TRUE,
                # Set the color of the points to decades variable:
                col.ind = pop_pca_df$track_popularity, 
                # Modify the color of the variables
                col.var = "darkblue") +
   scale_color_gradient(low = "white", high = "darkorange") +
   labs(color = "Track Popularity") +
   theme(legend.position = "bottom")
```

For the first question, a PCA analysis was performed on the quantitative variables (song characteristics), even though the scree plot indicated that up to PC3 is good enough for explaining the dimensions, the biplot and scatterplot embedded `track_popularity` is too chaotic to observe any sign between the variables. \
Thus a PCA analysis of smaller scale (selected by `playlist_genre`) was performed and `pop` and `r&b` were selected for the analysis. For `r&b`:

```{r rnb-pca-analysis, include=FALSE}
# For r&b
rnb_quant <- spotify[spotify$playlist_genre == "r&b",
                    c(4, 12:13, 15, 17:23)]

rnb_pca <- prcomp(dplyr::select(rnb_quant, danceability:duration_ms),
                     center = TRUE, scale. = TRUE)
summary(rnb_pca)
```

```{r rnb-scree-plot, include=FALSE}
fviz_eig(rnb_pca, addlabels = TRUE, ncp = 10) +
  geom_hline(yintercept = 100 * (1 / ncol(rnb_pca$x)), 
             linetype = "dashed", color = "red")
```

```{r rnb-pca, include=FALSE}
rnb_pc_matrix <- rnb_pca$x

rnb_pca_df <- spotify[spotify$playlist_genre == "r&b",] %>% 
  mutate(pc1 = rnb_pc_matrix[,1], pc2 = rnb_pc_matrix[,2],
         pc3 = rnb_pc_matrix[,3], pc4 = rnb_pc_matrix[,4])
rnb_pca <- rnb_pca_df %>%
  ggplot(aes(x = pc1, y = pc3)) +
  geom_point(aes(color = track_popularity), alpha = 0.5) +
  scale_colour_gradient(low = "white", high = "orange") +
  theme_bw() +
  labs(x = "PC 1", y = "PC 2", color = "Track Popularity")

plot(rnb_pca)
```

```{r rnb-biplot, include=FALSE}
fviz_pca_biplot(rnb_pca,
                # Plot PC1 and PC3
                axes = c(1, 2), label = "var",
                # Change the alpha for the observations - 
                # which is represented by ind
                alpha.ind = .25,
                # Modify the alpha for the variables (var):
                alpha.var = .5,
                repel = TRUE,
                # Set the color of the points to decades variable:
                col.ind = rnb_pca_df$track_popularity, 
                # Modify the color of the variables
                col.var = "darkblue") +
   scale_color_gradient(low = "white", high = "darkorange") +
   labs(color = "Track Popularity") +
   theme(legend.position = "bottom")
```

It turned out to be the same thing, as analysis on the other genres also indicated. Thus it seemed like that the popularity of the song can not be simply determined by a few variables representing the characteristics of the song (individually). 

## Question 2: What song characteristics does a given genre have?
## Question 3: What characteristics do top 100 songs in terms of popularity have?

```{r spotify-100}
spotify_100 <- spotify %>% 
  arrange(-track_popularity) %>% 
  top_n(150, track_popularity)
```

```{r genre-100}
bar_100 <- spotify_100 %>% 
  ggplot(aes(x = playlist_genre, fill = playlist_subgenre)) +
  geom_bar(position = "dodge")

plot(bar_100)
```

## Question 4: Are there correlations or collinearity between variables?

```{r corr, fig.height=7, fig.width=7, fig.cap="Correlation matrix", include=FALSE}
spotify_cor <- cor(spotify[, -c(1:3, 5:11)], method = "pearson")

corrplot::corrplot(spotify_cor, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45, diag = F, tl.cex = 0.5)
```

Observed from the correlogram, there exists some pairs of variables with high correlations: `energy:loudness` are positively correlated, `energy:acousticness` are negatively correlated; following by `danceability:valence` and `loudness:acousticness` which are slightly less correlated but the relationship are still significant. However, the relationship between variables are based on the scale of entire dataset, which there might be a big difference for the relationship of song characteristics between different genres. Thus two specific genres were also selected and the correlogram were below: 

```{r rnb-corr, fig.height=7, fig.width=7, fig.cap="Correlation matrix for RnB songs", include=FALSE}
rnb_cor <- cor(spotify[spotify$playlist_genre == "r&b", -c(1:3, 5:11)],
               method = "pearson")

corrplot::corrplot(rnb_cor, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45, diag = F, tl.cex = 0.5)
```

```{r pop-corr, fig.height=7, fig.width=7, fig.cap="Correlation matrix for Pop songs", include=FALSE}
pop_cor <- cor(spotify[spotify$playlist_genre == "pop", -c(1:3, 5:11)],
               method = "pearson")

corrplot::corrplot(pop_cor, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45, diag = F, tl.cex = 0.5)
```

As the correlograms suggested, the pairs of variables/characteristic of the song that are correlated for different genres are very different. This is indicating the variables are representing different context under different genre.


# Discussion:

The PCA analysis performed on the entire spotify dataset wasn't showing a clear relationship between the characteristics variables and the track popularity, thus the later studies went further into selected genres. A more complex regression analysis could be performed on the dataset to gain further understanding the explainability of characteristics of the songs on the track popularity. If the regression analysis went succeed, we might be able to provide service for creator and companies understand the trend or the popularity of the songs thus they could create and upload better content and make profit. The scale would be more focused within each genre, since a generalized "popular" song is hard to predict but for a specific genre it would be more sensible and feasible.

For future plans, since patterns of characteristics were observed within genres, if user data could be included a recommendation system would be a good next step plan. The recommendation could be applied to the radio when music app user is listening to the music, recommending a better next song; or it made life easy when new songs are uploaded by the creators, we
